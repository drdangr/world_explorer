# Project Overview

## Концепция

World Explorer — текстовая ролевая игра, в которой игрок исследует процедурно расширяемые миры под руководством ИИ‑Гейм‑мастера. Каждый мир представляет собой граф взаимосвязанных локаций, обогащающийся по мере исследования: ГМ описывает окружение, создаёт новые пути, генерирует предметы и учитывает индивидуальность персонажа игрока.

### Цели

- Создать бесконечно расширяемое интерактивное повествование с учётом контекста мира и героя.
- Хранить состояние миров, персонажей и их инвентаря локально (JSON) с возможностью последующей миграции в облако (Supabase).
- Обеспечить удобный UI с чатом, каталогом миров и визуализацией графа локаций.

## Игровой цикл

1. **Главный экран**: выбор существующего мира или создание нового; управление персонажами.
2. **Создание мира**: указание сеттинга, атмосферы и жанра (либо генерация на основе пресета). Формируется стартовая локация с центральной нодой.
3. **Создание персонажа**: имя, описание, стартовый инвентарь (пустой).
4. **Инициализация сессии**: игрок запрашивает вступительное описание; ГМ даёт литературный нарратив и фиксирует сухое `mapDescription` для карты.
5. **Исследование**:
   - Игрок пишет любое действие («пройти через чёрный ход», «взять нож» и т. д.).
   - API `/api/session` собирает контекст (мир, персонаж, история), вызывает LLM‑адаптер и применяет ответ к графу через `applyGameTurn`.
   - ГМ возвращает нарратив от первого лица, обновлённые `mapDescription`, список новых локаций, предметов и подсказок.
6. **Сохранение состояния**: после каждого хода обновляются JSON‑карта мира, краткие описания локаций, история сессий и инвентарь персонажа.
7. **Выход**: возвращение на главный экран с сохранением прогресса.

## Пользовательские роли

- **Игрок** — управляет персонажами и их действиями.
- **Гейм‑мастер (LLM)** — описывает мир, решает о допустимости действий, генерирует новые локации и предметы.

## Архитектура

- **Frontend**: Next.js 14 (App Router) + TypeScript + Tailwind CSS. Управление состоянием через Zustand. Визуализация графа — React Flow.
- **Backend (локально)**: серверные роуты Next.js. CRUD операции для миров и персонажей + `/api/session` для игрового цикла. Хранение в `data/worlds.json`, `data/characters.json`.
- **LLM‑адаптер**: модуль `src/lib/llm` с провайдерами Gemini Pro и Mock. Подключение других LLM реализуется через единую фабрику `getLLMProvider`.
- **Интеграция**: конфигурация провайдеров через переменные окружения (`GEMINI_API_KEY`, `OPENAI_API_KEY`, `ANTHROPIC_API_KEY`, `LLM_PROVIDER`).

## Модель данных

```ts
type WorldId = string;
type LocationId = string;
type CharacterId = string;

interface World {
  id: WorldId;
  name: string;
  setting: string;
  atmosphere: string;
  genre: string;
  createdAt: string;
  updatedAt: string;
  entryLocationId: LocationId;
  graph: Record<LocationId, LocationNode>;
  ownerCharacterIds: CharacterId[];
}

interface LocationNode {
  id: LocationId;
  locationName: string;
  mapDescription: string | null; // сухое описание для карты
  description: string | null; // последнее литературное описание (для удобства)
  discovered: boolean;
  items: Item[];
  connections: Connection[];
}

interface Connection {
  id: string;
  targetId: LocationId;
  label: string; // фраза-команда для перехода (например, "отправиться в")
  bidirectional: boolean;
}

interface Item {
  id: string;
  name: string;
  description: string;
  portable: boolean;
  ownerCharacterId: CharacterId | null;
}

interface Character {
  id: CharacterId;
  name: string;
  description: string;
  inventory: Item[];
  currentWorldId: WorldId | null;
  currentLocationId: LocationId | null;
  lastSessionFile: string | null;
  lastSessionEntryId: SessionEntryId | null;
}

interface SessionLog {
  worldId: WorldId;
  characterId: CharacterId;
  startedAt: string;
  entries: SessionEntry[];
}

interface SessionEntry {
  id: SessionEntryId;
  locationId: LocationId;
  author: 'player' | 'gm';
  message: string;
  createdAt: string;
}
```

## UI-компоненты

1. **Левая панель** (25 % ширины):
   - Настройки LLM и сугубо технические параметры.
   - Панель персонажей с возможностью переключения и редактирования.
   - Список миров, кнопки создания/редактирования/удаления.
2. **Центральная панель** (50 %):
   - Журнал чата «ГМ ↔ игрок».
   - Поле ввода сообщения, история действий, индикаторы активности.
3. **Правая панель** (25 %):
   - Граф локаций (React Flow).
   - Детали выбранной ноды, предметы, доступные пути.

## LLM‑интеграция

- **Контекст запроса**: сеттинг/атмосфера/жанр мира, данные персонажа, текущая локация, компактный реестр известных локаций (`mapDescription` + связи) и до 12 последних реплик истории. В системную подсказку включено правило «используй точное название известной локации». При повторном входе в локацию планируется добавлять напоминание о последнем действии (`SessionEntry` из текущего `SessionLog`).
- **Ответ LLM**: строгий JSON (`mapDescription`, `narration`, `playerLocation`, `discoveries`, `inventory`, `suggestions`), где `mapDescription` — сухая выжимка, а `narration` — художественный текст от первого лица.
- **Обработка**: `applyGameTurn` нормализует имена локаций, обновляет `mapDescription`, синхронизирует предметы (с сохранением идентификаторов), добавляет новые связи и распределяет историю по файлам `sessions/`. Новый узел сверяется не только по названию, но и по `mapDescription`, что исключает дубли («Бар Каменная Сопля», «Бар Каменная Сопля у входа» и т. п.).
- **Провайдеры**:
  - `GeminiProvider` — боевой режим (требует `GEMINI_API_KEY`).
  - `MockProvider` — офлайн‑заглушка: расширяет граф по сценариям (чёрный ход, кухня, улица и т. д.), обеспечивает стабильную работу без ключей.

## Будущее развитие

- Миграция хранилища на Supabase (PostgreSQL + Storage) с синхронизацией в реальном времени.
- Поддержка нескольких LLM с интерфейсом выбора.
- Расширение системы предметов (действия «использовать», «комбинировать»).
- Совместные путешествия нескольких игроков после внедрения аутентификации.
- Оптимизация промптов и кэширование состояний для более быстрого отклика ГМ.
- Генерация визуальных карточек локаций и предметов, экспорт/импорт миров.


