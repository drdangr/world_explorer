# World Explorer

World Explorer — веб‑приложение для интерактивных текстовых путешествий по генерируемым мирам. Игрок создаёт персонажей, выбирает или формирует мир с уникальными сеттингом, атмосферой и жанром, а затем взаимодействует с Гейм‑мастером (LLM), исследуя локации, предметы и связи между ними.

## Возможности прототипа

- Трипанельный интерфейс: слева управление мирами и персонажами, в центре чат с ГМ, справа граф локаций на базе React Flow.
- Локальное хранилище (`data/worlds.json`, `data/characters.json`, `data/sessions/`) с централизованной записью карты мира, состояния персонажей и историй путешествий.
- Управление персонажами и мирами (создание, редактирование, удаление, привязка персонажа к миру, генерация случайных пресетов).
- Сессия общения с ГМ: история ходов, подсказки для игрока, поддержка вступительного описания мира и последовательных действий.
- Двухуровневые описания локаций: `mapDescription` хранит каноничную «сухую» выжимку для карты, а `narration` генерируется на лету с учётом сеттинга и настроек персонажа.
- Гарантированная консистентность графа: ГМ получает инструкцию использовать точные названия известных локаций, а движок дедуплицирует новые узлы по `mapDescription`.
- Инвентарь персонажа: предметы перемещаются между локациями и героем по решениям ГМ, данные сохраняются между сессиями.
- Адаптер LLM с поддержкой Gemini Pro (через `@google/generative-ai`) и fallback‑провайдером Mock для офлайн‑режима.

## Быстрый старт

```bash
pnpm install
pnpm dev
```

Приложение доступно на `http://localhost:3000`. Для проверки стиля и типизации используйте `pnpm lint`
(в некоторых окружениях может потребоваться установить `@babel/helper-validator-identifier` вручную).

### Структура данных

- `data/worlds.json` — все миры, графы локаций и предметы.
- `data/characters.json` — персонажи (`currentWorldId`, `currentLocationId`, `inventory`, `lastSessionFile`, `lastSessionEntryId`).
- `data/sessions/` — отдельные файлы вида `session__{characterId}__{worldId}__{YYYYMMDD_HHmmss}.json` с логами путешествий:

  ```json
  {
    "worldId": "...",
    "characterId": "...",
    "startedAt": "2025-11-07T00:30:00Z",
    "entries": [ { "id": "...", "author": "player", ... } ]
  }
  ```

  Текущая сессия определяется полем `lastSessionFile` у персонажа, а `lastSessionEntryId` ускоряет поиск последнего хода.

### Конфигурация LLM

1. Создайте файл `.env.local` в корне проекта и добавьте ключи:

   ```bash
   GEMINI_API_KEY=ваш_ключ
   LLM_PROVIDER=gemini # или mock для локальной отладки без ключа
   GEMINI_MODEL=gemini-2.0-flash-001
   ```

2. Перезапустите dev‑сервер. При отсутствии ключа автоматически используется мок‑провайдер, генерирующий правдоподобные ответы и расширяющий граф на основе шаблонов. Если Gemini выдаёт 404 или пустые ответы, подберите актуальную модель:

   ```bash
   pnpm dlx tsx scripts/listModels.ts
   ```

   Для локальных проверок также можно вызвать

   ```bash
   GEMINI_MODEL=gemini-2.0-flash-001 pnpm dlx tsx scripts/testGemini.ts "осмотреть улицу"
   ```

   Скрипт покажет «сырой» ответ модели и облегчит отладку промптов.

### Структура репозитория

- `src/app` — точки входа Next.js (App Router).
- `src/features` — UI‑модули (Dashboard, ChatPanel, граф и т. д.).
- `src/store` — Zustand‑хранилище приложения.
- `src/lib` — игровые доменные сервисы, адаптеры LLM и репозитории работы с JSON.
- `data/` — локальные JSON‑файлы с состоянием миров и персонажей.
- `docs/` — подробная документация (концепция и roadmap).

## Документация

- `docs/project_overview.md` — концепция игры, модель данных, UX‑сценарии.
- `docs/roadmap.md` — дорожная карта с прогрессом по этапам.

## Следующие шаги

Переезд хранения на Supabase, подключение дополнительных LLM (OpenAI, Anthropic), доработка UI и подготовка деплоя на Vercel описаны в `docs/roadmap.md`.
